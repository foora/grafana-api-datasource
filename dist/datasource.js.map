{"version":3,"sources":["datasource.js"],"names":["ApiDataSource","instanceSettings","$q","backendSrv","templateSrv","q","name","type","url","withCredentials","headers","basicAuth","length","parser","Parser","options","queryConfig","parseQueryConfig","targets","Object","keys","path","method","when","data","requestOptions","toUpperCase","query","startTime","Date","range","from","_d","getTime","endTime","to","doRequest","then","res","parseQueryResponse","response","status","message","title","datasourceRequest"],"mappings":"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","sourcesContent":["import { Parser } from './data_parser';\n\nexport class ApiDataSource {\n    constructor(instanceSettings, $q, backendSrv, templateSrv) {\n        this.q = $q;\n        this.backendSrv = backendSrv;\n        this.templateSrv = templateSrv;\n        this.name = instanceSettings.name;\n        this.type = instanceSettings.type;\n        this.url = instanceSettings.url;\n        this.withCredentials = instanceSettings.withCredentials;\n        this.headers = {\n            'Content-Type': 'application/json'\n        };\n        if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n            this.headers['Authorization'] = instanceSettings.basicAuth;\n        }\n        this.parser = new Parser();\n    }\n\n    query(options) {\n        let queryConfig = this.parser.parseQueryConfig(options.targets[0].queryConfig);\n        if (Object.keys(queryConfig).length === 0 || !queryConfig.path || !queryConfig.method) {\n            return this.q.when({ data: [] });\n        }\n        let requestOptions = {\n            url: this.url + queryConfig.path,\n            method: queryConfig.method\n        };\n        if (queryConfig.method.toUpperCase() !== 'GET') {\n            requestOptions.data = queryConfig.query || {};\n            requestOptions.data.startTime = new Date(options.range.from._d).getTime();\n            requestOptions.data.endTime = new Date(options.range.to._d).getTime();\n        }\n        return this.doRequest(requestOptions).then((res) => this.parser.parseQueryResponse(res, queryConfig));\n    }\n\n    testDatasource() {\n        return this.doRequest({\n            url: this.url + '/test',\n            method: 'GET'\n        }).then(response => {\n            if (response.status === 200) {\n                return { status: 'success', message: 'Data source is working', title: 'Success' };\n            }\n        });\n    }\n\n    doRequest(options) {\n        options.withCredentials = this.withCredentials;\n        options.headers = this.headers;\n        return this.backendSrv.datasourceRequest(options);\n    }\n}"],"file":"datasource.js"}